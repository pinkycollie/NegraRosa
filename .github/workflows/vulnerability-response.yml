# Vulnerability Response Workflow - MBTQ Ecosystem
# Automated response and tracking for security vulnerabilities
#
# Triggers:
# - Dependabot alerts
# - Security advisories
# - Manual dispatch for incident response

name: Vulnerability Response

on:
  # Triggered by Dependabot security alerts
  repository_dispatch:
    types: [security-alert]
  
  # Manual trigger for incident response
  workflow_dispatch:
    inputs:
      severity:
        description: 'Vulnerability severity'
        required: true
        type: choice
        options:
          - critical
          - high
          - medium
          - low
      description:
        description: 'Brief description of the vulnerability'
        required: true
        type: string
      affected_component:
        description: 'Affected component/service'
        required: true
        type: choice
        options:
          - deafauth
          - pinksync
          - fibonacci
          - ai-proxy
          - vr-compliance
          - automl
          - video-processing
          - other
      cve_id:
        description: 'CVE ID (if applicable)'
        required: false
        type: string

permissions:
  contents: read
  issues: write
  security-events: read

jobs:
  # ==================== Triage Vulnerability ====================
  triage:
    name: Triage Vulnerability
    runs-on: ubuntu-latest
    outputs:
      priority: ${{ steps.assess.outputs.priority }}
      response_time: ${{ steps.assess.outputs.response_time }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Assess Severity
        id: assess
        run: |
          SEVERITY="${{ github.event.inputs.severity || 'medium' }}"
          
          case $SEVERITY in
            critical)
              echo "priority=P0" >> $GITHUB_OUTPUT
              echo "response_time=1h" >> $GITHUB_OUTPUT
              ;;
            high)
              echo "priority=P1" >> $GITHUB_OUTPUT
              echo "response_time=4h" >> $GITHUB_OUTPUT
              ;;
            medium)
              echo "priority=P2" >> $GITHUB_OUTPUT
              echo "response_time=24h" >> $GITHUB_OUTPUT
              ;;
            low)
              echo "priority=P3" >> $GITHUB_OUTPUT
              echo "response_time=7d" >> $GITHUB_OUTPUT
              ;;
          esac
          
          echo "## ðŸš¨ Vulnerability Triage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Severity:** $SEVERITY" >> $GITHUB_STEP_SUMMARY
          echo "**Priority:** $(cat $GITHUB_OUTPUT | grep priority | cut -d= -f2)" >> $GITHUB_STEP_SUMMARY
          echo "**Response Time:** $(cat $GITHUB_OUTPUT | grep response_time | cut -d= -f2)" >> $GITHUB_STEP_SUMMARY

  # ==================== Create Incident Tracking ====================
  create-incident:
    name: Create Incident Issue
    runs-on: ubuntu-latest
    needs: triage
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Create security incident issue
        uses: actions/github-script@v7
        with:
          script: |
            const severity = '${{ github.event.inputs.severity }}';
            const description = '${{ github.event.inputs.description }}';
            const component = '${{ github.event.inputs.affected_component }}';
            const cveId = '${{ github.event.inputs.cve_id }}' || 'N/A';
            const priority = '${{ needs.triage.outputs.priority }}';
            const responseTime = '${{ needs.triage.outputs.response_time }}';
            
            const severityEmoji = {
              critical: 'ðŸ”´',
              high: 'ðŸŸ ',
              medium: 'ðŸŸ¡',
              low: 'ðŸŸ¢'
            };
            
            const issueBody = `
## ${severityEmoji[severity]} Security Vulnerability Report

### Summary
${description}

### Details
| Field | Value |
|-------|-------|
| Severity | ${severity.toUpperCase()} |
| Priority | ${priority} |
| Response Time | ${responseTime} |
| Affected Component | ${component} |
| CVE ID | ${cveId} |

### Checklist
- [ ] Verify vulnerability
- [ ] Assess impact on MBTQ ecosystem
- [ ] Check DeafAUTH accessibility impact
- [ ] Identify affected users
- [ ] Develop fix
- [ ] Test fix
- [ ] Deploy to staging
- [ ] Deploy to production
- [ ] Notify affected users (visual notification)
- [ ] Post-incident review

### Visual Feedback for Deaf Users ðŸŽ¯
When communicating about this vulnerability:
- Use visual indicators (icons, colors)
- Avoid audio-only notifications
- Provide written status updates
- Include haptic feedback patterns if applicable

### Related Services
${component === 'deafauth' ? 'âš ï¸ This affects DeafAUTH - ensure all fixes maintain accessibility' : ''}
${component === 'pinksync' ? 'âš ï¸ This affects PinkSync - check offline sync implications' : ''}
${component === 'fibonacci' ? 'âš ï¸ This affects Fibonacci Security - review trust calculations' : ''}

---
*Auto-generated by MBTQ Security Response Workflow*
            `;
            
            const labels = ['security', `severity:${severity}`, `component:${component}`];
            if (severity === 'critical' || severity === 'high') {
              labels.push('urgent');
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SECURITY] ${priority}: ${description.substring(0, 50)}...`,
              body: issueBody,
              labels: labels
            });

  # ==================== Automated Dependency Update ====================
  auto-update:
    name: Attempt Automated Fix
    runs-on: ubuntu-latest
    needs: triage
    if: needs.triage.outputs.priority == 'P0' || needs.triage.outputs.priority == 'P1'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Run npm audit fix
        run: |
          npm audit fix || true
          
          # Check if any changes were made
          if git diff --quiet; then
            echo "No automatic fixes available"
            echo "## âš ï¸ Manual Review Required" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Automatic fixes applied" >> $GITHUB_STEP_SUMMARY
            git diff --stat >> $GITHUB_STEP_SUMMARY
          fi

  # ==================== Security Notification ====================
  notify:
    name: Security Notification
    runs-on: ubuntu-latest
    needs: [triage, create-incident]
    if: always() && (needs.triage.outputs.priority == 'P0' || needs.triage.outputs.priority == 'P1')
    
    steps:
      - name: Generate notification summary
        run: |
          echo "## ðŸ“¢ Security Alert Notification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A ${{ needs.triage.outputs.priority }} security vulnerability has been detected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Response Time:** ${{ needs.triage.outputs.response_time }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Visual Notification ðŸ””" >> $GITHUB_STEP_SUMMARY
          echo "For Deaf-first platform: Check GitHub Issues for detailed tracking." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Icon Pattern:** ðŸš¨ (Critical) ðŸŸ  (High) ðŸŸ¡ (Medium) ðŸŸ¢ (Low)" >> $GITHUB_STEP_SUMMARY
